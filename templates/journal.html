{% extends "base.html" %}
{% block title %}Journal — Dream IRT{% endblock %}
{% block content %}
  <div class="card mb-4">
    <div class="grid gap-3">
      <label>Sleep quality: <span id="sqv">3</span>/5</label>
      <input id="sq" type="range" min="1" max="5" value="3" class="w-full">
      <label>Nightmare intensity: <span id="niv">3</span>/5</label>
      <input id="ni" type="range" min="1" max="5" value="3" class="w-full">
      <input id="emo" class="rounded-xl bg-slate-900 border border-slate-700 p-2" placeholder="Emotions (optional)">
      <textarea id="note" class="rounded-xl bg-slate-900 border border-slate-700 p-2" placeholder="Note (optional)"></textarea>
      <button id="save" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Save</button>
    </div>
  </div>
  <div id="list" class="space-y-3"></div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  $("sq").oninput = ()=>$("sqv").textContent = $("sq").value;
  $("ni").oninput = ()=>$("niv").textContent = $("ni").value;

  async function fetchWithTimeout(url, opts={}, ms=20000){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),ms);
    try{ const r=await fetch(url,{...opts,signal:ctrl.signal}); clearTimeout(t); return r; }
    catch(e){ clearTimeout(t); throw e; }
  }

  async function load(){
    showLoader("Loading journal…");
    try{
      const data = await (await fetchWithTimeout("/get_journal")).json();
      $("list").innerHTML = data.map(e=>`
        <div class="card">
          <p class="text-sm text-slate-400">${new Date(e.created_at || Date.now()).toLocaleString()}</p>
          <p>Sleep ${e.sleep_quality}/5, Intensity ${e.nightmare_intensity}/5</p>
          ${e.emotions? `<p>Emotions: ${e.emotions}</p>`:''}
          ${e.note? `<p>${e.note}</p>`:''}
        </div>`).join("");
    } finally { hideLoader(); }
  }

  $("save").onclick = async ()=>{
    showLoader("Saving entry…");
    try{
      const payload = { sleep_quality:+$("sq").value, nightmare_intensity:+$("ni").value, emotions:$("emo").value, note:$("note").value };
      await fetchWithTimeout("/save_journal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}, 20000);
      $("emo").value=""; $("note").value=""; await load();
    } finally { hideLoader(); }
  };

  load();
})();
</script>
{% endblock %}
